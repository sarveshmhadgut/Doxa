name: Doxa CICD

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DAGSHUB_URI: ${{ secrets.DAGSHUB_URI }}
      DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      DATASET_BUCKET_NAME: ${{ secrets.DATASET_BUCKET_NAME }}
      PYTHONPATH: .

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install uv
      uses: astral-sh/setup-uv@v2

    - name: Set up Python
      run: uv python install 3.10

    - name: Sync Dependencies
      run: uv sync --all-extras --dev

    - name: Run DVC Pipeline
      run: uv run dvc repro

    - name: Run Model Tests
      run: uv run python tests/model_tests.py

    - name: Run App Tests
      run: uv run python tests/app_tests.py

    - name: Promote Model
      if: success()
      run: uv run python src/model/model_promotion.py

    - name: Upload Vectorizer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vectorizer
        path: models/vectorizer.pkl

  build:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Download Vectorizer Artifact
      uses: actions/download-artifact@v4
      with:
        name: vectorizer
        path: models

    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

    - name: Login to ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create ECR Repo
      env:
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      run: |
        aws ecr describe-repositories --repository-names $ECR_REPOSITORY || aws ecr create-repository --repository-name $ECR_REPOSITORY

    - name: Build Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

    - name: Tag Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - name: Push Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

    - name: Login to ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
            --region ${{ secrets.AWS_DEFAULT_REGION }} \
            --name doxa-app-cluster

    - name: Create Secrets
      run: |
        kubectl delete secret app-secrets --ignore-not-found
        kubectl create secret generic app-secrets \
          --from-literal=DAGSHUB_URI=${{ secrets.DAGSHUB_URI }} \
          --from-literal=DAGSHUB_USERNAME=${{ secrets.DAGSHUB_USERNAME }} \
          --from-literal=DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }} \
          --from-literal=DAGSHUB_REPO=${{ secrets.DAGSHUB_REPO }} \
          --from-literal=AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
          --from-literal=AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          --from-literal=AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}

    - name: EKS Deployment
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        envsubst < manifest.yaml | kubectl apply -f -
